#!/usr/bin/env bash

set -e

if [[ ! -f "$0" || "$0" == "bash" || "$0" == "/dev/fd/63" ]]; then
    REMOTE_INSTALL=true
    REPO_DIR="$HOME/dragon-boot"
    echo "üåê Remote installation detected - will install repository to $REPO_DIR"
    
    # üîß Dependency Check
    echo "[üîç] Checking for required packages..."
    if command -v apt &>/dev/null; then
        sudo apt update || { echo "‚ùå apt update failed"; exit 1; }
        sudo apt install -y plymouth plymouth-themes grub2-common || { echo "‚ùå apt install failed"; exit 1; }
    elif command -v pacman &>/dev/null; then
        sudo pacman -Sy --noconfirm plymouth grub || { echo "‚ùå pacman install failed"; exit 1; }
    elif command -v dnf &>/dev/null; then
        sudo dnf install -y plymouth grub2 || { echo "‚ùå dnf install failed"; exit 1; }
    else
        echo "‚ùå Unsupported package manager. Install dependencies manually."
        exit 1
    fi

    # Clone the repository if not already present
    if [[ ! -d "$REPO_DIR/.git" ]]; then
        git clone https://github.com/statikfintechllc/dragon-boot.git "$REPO_DIR" || { echo "‚ùå Git clone failed"; exit 1; }
    else
        echo "üîÑ Updating existing repository..."
        cd "$REPO_DIR" || { echo "‚ùå Failed to cd to $REPO_DIR"; exit 1; }
        git pull origin master || { echo "‚ùå Git pull failed"; exit 1; }
    fi

    cd "$REPO_DIR" || { echo "‚ùå Failed to cd to $REPO_DIR"; exit 1; }

    echo "[üîß] Installing Dragon Boot Theme..."

    # Ensure structure is valid
    if [ ! -d "frames" ] || [ ! -f "usr/share/plymouth/themes/dragon/dragon.plymouth" ]; then
        echo "‚ùå Invalid theme directory structure. Install failed. Check contents of $REPO_DIR."
        ls -R . || echo "‚ùå Could not list directory contents."
        exit 1
    fi

    # Copy frame PNGs
    echo "[üì¶] Copying frame assets to /usr/share/plymouth/themes/dragon"
    sudo mkdir -p /usr/share/plymouth/themes/dragon || { echo "‚ùå Failed to create theme directory"; exit 1; }
    sudo cp -v frames/frame_*.png /usr/share/plymouth/themes/dragon/ || { echo "‚ùå Failed to copy frame assets"; ls frames/ || echo "‚ùå Frame directory empty or inaccessible."; exit 1; }

    # Copy plymouth theme files
    echo "[üìú] Copying plymouth theme definition and script"
    sudo cp -v usr/share/plymouth/themes/dragon/*.plymouth /usr/share/plymouth/themes/dragon/ || { echo "‚ùå Failed to copy plymouth files"; ls usr/share/plymouth/themes/dragon/ || echo "‚ùå Plymouth theme files missing."; exit 1; }
    sudo cp -v usr/share/plymouth/themes/dragon/*.script /usr/share/plymouth/themes/dragon/ || { echo "‚ùå Failed to copy script files"; ls usr/share/plymouth/themes/dragon/ || echo "‚ùå Script files missing."; exit 1; }

    # Copy plymouthd.conf
    echo "[üóÇÔ∏è] Setting plymouthd.conf to use dragon theme"
    sudo mkdir -p /etc/plymouth || { echo "‚ùå Failed to create plymouth config directory"; exit 1; }
    sudo cp -v etc/plymouth/plymouthd.conf /etc/plymouth/plymouthd.conf || { echo "‚ùå Failed to copy plymouthd.conf"; ls etc/plymouth/ || echo "‚ùå plymouthd.conf missing."; exit 1; }

    # Patch /etc/default/grub
    echo "[‚öôÔ∏è] Patching /etc/default/grub..."
    sudo sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=3 fbcon=map:1 gfxpayload=keep video=efifb bgrt_disable"/' /etc/default/grub || { echo "‚ùå Failed to patch GRUB_CMDLINE"; exit 1; }
    if ! grep -q "^GRUB_GFXMODE=" /etc/default/grub; then
        echo 'GRUB_GFXMODE=1800x1200' | sudo tee -a /etc/default/grub || { echo "‚ùå Failed to set GRUB_GFXMODE"; exit 1; }
    else
        sudo sed -i 's/^GRUB_GFXMODE=.*/GRUB_GFXMODE=1920x1080/' /etc/default/grub || { echo "‚ùå Failed to update GRUB_GFXMODE"; exit 1; }
    fi
    if ! grep -q "^GRUB_GFXPAYLOAD_LINUX=" /etc/default/grub; then
        echo 'GRUB_GFXPAYLOAD_LINUX=keep' | sudo tee -a /etc/default/grub || { echo "‚ùå Failed to set GRUB_GFXPAYLOAD_LINUX"; exit 1; }
    else
        sudo sed -i 's/^GRUB_GFXPAYLOAD_LINUX=.*/GRUB_GFXPAYLOAD_LINUX=keep/' /etc/default/grub || { echo "‚ùå Failed to update GRUB_GFXPAYLOAD_LINUX"; exit 1; }
    fi

    # Update GRUB and initramfs
    echo "[üîÑ] Updating bootloader and initramfs..."
    sudo update-grub || { echo "‚ùå update-grub failed"; exit 1; }
    sudo update-initramfs -u -v || { echo "‚ùå update-initramfs failed"; exit 1; }

    echo "[‚úÖ] Dragon Boot Theme Installed Successfully!"
fi

# Reboot prompt
read -rp $'\n[üöÄ] Reboot now to apply changes? [y/N]: ' confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo "[‚ôªÔ∏è] Rebooting..."
    sudo reboot
else
    echo "[‚è≠Ô∏è] Reboot skipped. Please reboot manually to see your dragon."
fi
